---

title: Memery


keywords: fastai
sidebar: home_sidebar

summary: "Use human language to search your image folders!"
description: "Use human language to search your image folders!"
nb_path: "index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="What-is-memery?">What is memery?<a class="anchor-link" href="#What-is-memery?"> </a></h2><p><img src="/memery/images/E2GoeMyWEAAkcLz.jpeg" alt="meme about having too many memes"></p>
<p>The problem: you have a huge folder of images. Memes, screenshots, datasets, product photos, inspo albums, anything. You know that somewhere in that folder is the exact image you want, but you can't remember the filename or what day you saved it. There's nothing you can do but scroll through the folder, skimming hundreds of thumbnails, hoping you don't accidentally miss it, and that you'll recognize it when you do see it.</p>
<p>Humans do this amazingly well. But even with computers, local image search is still a manual effort - you're still sorting through folders of images, like an archivist of old.</p>
<p><strong>Now there's Memery</strong>.</p>
<p>The <code>memery</code> package provides natural language search over local images. You can use it to search for things like "a line drawing of a woman facing to the left" and get <em>reasonably good results!</em></p>
<p>You can do this over thousands of images (it's not optimized for performance yet, but search times scale well under O(n)).</p>
<p>You can view the images in a browser GUI, or pipe them through command line tools.</p>
<p>You can use <code>memery</code> or its modules in Jupyter notebooks, including GUI functions!</p>
<p>Under the hood, <code>memery</code> makes use of <strong>CLIP</strong>, the <a href="https://github.com/openai/CLIP">Contrastive Language-Image Pretraining transformer</a>, released by OpenAI in 2021. CLIP trains a vision transformer and a language transformer to find the same latent space for images and their captions. This makes it perfect for the purpose of natural language image search. CLIP is a giant achievement, and <code>memery</code> stands on its shoulders.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Outline:</p>
<ul>
<li>Usage<ul>
<li>Install locally</li>
<li>Use GUI</li>
<li>Use CLI</li>
<li>Use in Jupyter</li>
<li>Use the library</li>
</ul>
</li>
<li>Development<ul>
<li>Notebook-driven development</li>
<li>Pull the repo</li>
<li>Notebook-driven development</li>
<li>Change the notebooks</li>
<li>Test the notebooks</li>
<li>Notebook-driven development</li>
<li>Tangle the source code</li>
<li>Weave the documentation</li>
<li>Commit your changes</li>
</ul>
</li>
<li>Contributing<ul>
<li>Who works on this project</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Installation">Installation<a class="anchor-link" href="#Installation"> </a></h2><p>With Python 3.6 or greater:</p>

<pre><code>pip install memery
pip install git+https://github.com/openai/CLIP.git</code></pre>
<p>Currently memery defaults to GPU installation. This will 
probably be switched in a future version.</p>
<p>For now, if you want to run CPU-only, run the following command after installing memery:</p>
<p><code>pip install torch==1.7.1+cpu torchvision==0.8.2+cpu torchaudio==0.7.2 -f https://download.pytorch.org/whl/torch_stable.html</code></p>
<p>Someday memery will be packaged in an easy to use format, but since this is a Python project it is hard to predict when that day will be.</p>
<p>If you want to help develop memery, you'll need to clone the repo. See below.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Usage">Usage<a class="anchor-link" href="#Usage"> </a></h2><p>What's your use case?</p>
<p><strong>I have images and want to search them with a GUI app</strong></p>
<p>↳  Use the Browser GUI</p>
<p><strong>i have a program/workflow and want to use image search as one part of it</strong></p>
<p>↳ Use in Jupyter</p>
<p>↳ Use as a Python module</p>
<p>↳ Use from command line or shell scripts</p>
<p><strong>i want to improve on and/or contribute to memery development</strong></p>
<p>↳ Start by cloning the repo</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Use-GUI">Use GUI<a class="anchor-link" href="#Use-GUI"> </a></h3><p>Currently memery has a rough browser-based GUI. To launch it, run the following in a command line:</p>
<p><code>memery serve</code></p>
<p>or set up a desktop shortcut that points to the above command.</p>
<p>Memery will open in a browser window. The interface is pretty straightforward, but it has some quirks.</p>
<p><img src="/memery/./images/streamlit-screenshot.png" alt="screenshot of memery GUI displaying wholesome memes"></p>
<p>The sidebar on the left controls the location and query for the search. The "Directory" box requires a full directory path; unfortunately, Streamlit does not yet have a folder-picker component. The path is relative to your current working directory when you run <code>memery serve</code>.</p>
<p>The search will run once you enter a text or image query. If you enter both text and image queries, memery will search for the combination.</p>
<p>Beneath these widgets is the output area for temporary messages displayed with each search. Mostly this can be ignored.</p>
<p>The right hand panel displays the images and associated options. Major errors will appear here as giant stack traces; sometimes, changing variables in the other widgets will fix these errors live. If you get a large error here it's helpful to take a screenshot and share it with us in Github Issues.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Use-in-Jupyter">Use in Jupyter<a class="anchor-link" href="#Use-in-Jupyter"> </a></h3><p>If you're in a Jupyter environment, you can summon an ipywidgets GUI directly into an output cell like this:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">memery.gui</span> <span class="kn">import</span> <span class="n">appPage</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">appPage</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea ">
<pre>&lt;memery.gui.appPage at 0x7f829c87d290&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/memery/./images/jupyter-screenshot.png" alt="screenshot of memery Jupyter GUI displaying wholesome memes"></p>
<p>Unfortunately the widgets won't display without an active runtime, so the above is a screenshot. In a Jupyter environment, the GUI works just like the browser-based GUI.</p>
<p>Opening new appPage instances in separate cells can be helpful for exploring a dataset, but it can also cause memory overruns. For this reason the Jupyter interface is tabbed and each search will appear in a new tab.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Use-CLI">Use CLI<a class="anchor-link" href="#Use-CLI"> </a></h3><p>The memery command line is currently very rudimentary. So far you can use <code>memery</code> on any folder and it will search for images recursively, returning a list object to stdout.</p>
<p>Pass the --n flag to control how many images are returned (default 10).</p>
<p><code>memery recall PATH/TO/IMAGE/FOLDER 'query' --n 20</code></p>
<p>I'm not clear yet on what behavior command-line users will expect from it. In the future we may want to make it non-recursive by default, and map the behavior more closely to POSIX standards. I would love feedback or help on this.
`</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Use-as-a-library">Use as a library<a class="anchor-link" href="#Use-as-a-library"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The function currently called <a href="/memery/core.html#query_flow"><code>query_flow</code></a> accepts a folder name and a query and returns a ranked list of image files. This is also recursive by default, and prints too much information into stdout. And it calls index_flow every time, which can be annoying if you have corrupted files in the directory, as it will need to rebuild the tree-index each time despite the files not changing. This will be solved in a future release.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">memery.core</span> <span class="kn">import</span> <span class="n">query_flow</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ranked</span> <span class="o">=</span> <span class="n">query_flow</span><span class="p">(</span><span class="s1">&#39;./images&#39;</span><span class="p">,</span> <span class="s1">&#39;dad joke&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ranked</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>89it [00:00, 44503.23it/s]
89it [00:00, 37660.72it/s]
0it [00:00, ?it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>starting timer
Checking files
Indexing
Skipping bad file: images/memes/corrupted-file.jpeg
due to &lt;class &#39;PIL.UnidentifiedImageError&#39;&gt;
Skipping bad file: images/memes/.ipynb_checkpoints/corrupted-file-checkpoint.jpeg
due to &lt;class &#39;PIL.UnidentifiedImageError&#39;&gt;
Loaded 82 encodings
Encoding 0 new images
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>0it [00:00, ?it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Building treemap
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Saving 82 encodings
Converting query
Searching 82 images
Done in 0.5853581428527832 seconds
[&#39;images/memes/Wholesome-Meme-68.jpg&#39;, &#39;images/memes/Wholesome-Meme-74.jpg&#39;, &#39;images/memes/Wholesome-Meme-88.jpg&#39;, &#39;images/memes/Wholesome-Meme-78.jpg&#39;, &#39;images/memes/Wholesome-Meme-23.jpg&#39;]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here's the first result from that list:</p>
<p><img src="/memery/images/memes/Wholesome-Meme-68.jpg" alt=""></p>
<p>So that's how to use memery. Let's look at how you can help make it better.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Development">Development<a class="anchor-link" href="#Development"> </a></h2><p>Memery is a different beast than most pieces of code you've seen. It's a <em>literate program</em>: a program written for human beings to read.</p>
<p>Nothing in this code is particularly special. The algorithms, data structures, and pipeline are either bog-standard or even subpar. The model was developed by OpenAI, and the tree indexer by Spotify. All I did was glue a bunch of disparate things together.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Notebook-driven-development">Notebook-driven development<a class="anchor-link" href="#Notebook-driven-development"> </a></h3><p>The thing that makes this program interesting is that it was developed <strong>in Jupyter notebooks</strong>. Each component has its code and documentation in the same place, a <code>.ipynb</code> notebook.</p>
<p>This is possible thanks to a new-ish project called <code>nbdev</code>. It provides literate programming functionality for notebooks. Specifically, it allows the programmer to automatically weave code and tangle documentation from the content of the notebooks!</p>
<p>This means that relevant docs, code and tests for that code all live in the same location. And ideally, that place is a notebook <em>written for humans</em>. I'm still getting the hang of this, but it means explaining <em>why</em> something works, rather than simply how to do it.</p>
<p>So that's the <em>why</em> of notebook-driven development. Let's look at <em>how</em> that works in practice.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Pull-the-repo">Pull the repo<a class="anchor-link" href="#Pull-the-repo"> </a></h3><p>Clone this repository from Github:</p>
<p><code>git clone https://github.com/deepfates/memery.git</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Install-dependencies-and-memery">Install dependencies and memery<a class="anchor-link" href="#Install-dependencies-and-memery"> </a></h3><p>Enter the <code>memery</code> folder and install requirements:</p>

<pre><code>cd memery
pip install requirements.txt</code></pre>
<p>We also have to download the CLIP model directly from their git repo, as they decline to upload it to PyPi:</p>
<p><code>pip install git+https://github.com/openai/CLIP.git</code></p>
<p>And finally install your local, editable copy of memery with</p>
<p><code>pip install -e .</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Notebook-driven-development">Notebook-driven development<a class="anchor-link" href="#Notebook-driven-development"> </a></h3><p>Within the main memery folder there is a subfolder <code>memery/memery</code>. This contains <code>.py</code> files, which are the source code for the repo. You might be tempted to edit these Python files directly, but you must hesitate.</p>
<p>Remember: we are doing notebook-driven development. The Python files in that folder are auto-generated from the <code>.ipynb</code> files in this folder. If you edit them directly, the notebooks could overwrite your code in a future build. There are ways to backport code from the <code>.py</code> files to the notebooks, but it's not recommended.</p>
<p>The reason we write the code in notebooks is to keep documentation and tests right next to their code. This single source of truth will percolate to the docs, code packages and testing framework.</p>
<p>:warning: Always edit the notebook files, not the .py files! :warning:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Change-the-notebooks">Change the notebooks<a class="anchor-link" href="#Change-the-notebooks"> </a></h3><p>This is the part you came here for. Change the code in the notebooks as you need.</p>
<p>Change the <strong>documentation</strong> as well, to match your new code. Code should be documented as closely to the cell where it is used as possible. The more general design should be at the top of the notebook, and implementation-specific details further down.</p>
<p>Each notebook should also contain <strong>tests</strong> for the code it defines. These can be simple assert statements which return True.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-the-notebooks">Test the notebooks<a class="anchor-link" href="#Test-the-notebooks"> </a></h3><p>The following command will run each notebook in the main folder and report if any cells return False or raise errors. We pause for a couple seconds between starting each notebook, to avoid collisions accessing the GPU.</p>
<p><code>nbdev_test_nbs --pause 2</code></p>
<p>Always run tests before committing your changes.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Notebook-driven-development">Notebook-driven development<a class="anchor-link" href="#Notebook-driven-development"> </a></h3><p>As an interpreted language, Python doesn't usually have a "compile" step. But as a literate program, Memery is written for humans first and computers second. To get a clean Python module, free of documentation and tests, we <strong>tangle</strong> the source code into the <code>/memery</code> directory, then <strong>weave</strong> the documentation.</p>
<p>Any code with the <code>#export</code> tag at the beginning of its cell will be tangled into the appropriate .py file. Any code cell with <code>#hide</code> will be hidden from the docs.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Tangle-the-source-code">Tangle the source code<a class="anchor-link" href="#Tangle-the-source-code"> </a></h3><p>To tangle code into <code>/memery</code>, use the following in a command line:</p>
<p><code>nbdev_build_lib</code></p>
<p>I often use <code>nbdev_build_lib &amp;&amp; pip install -e</code> (although I'm no longer sure if it's necessary to reinstall an editable module).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Weave-the-documentation">Weave the documentation<a class="anchor-link" href="#Weave-the-documentation"> </a></h3><p>To generate the documentation website, use <code>nbdev_build_docs</code>. Or, get a live preview using <code>make docs_serve</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Commit-your-changes">Commit your changes<a class="anchor-link" href="#Commit-your-changes"> </a></h3><p>Before committing, clean useless metadata from your notebooks with <code>nbdev_clean_nbs</code>. Or, install the nbdev pre-commit hooks to do this automatically with <code>nbdev_install_git_hooks</code>.</p>
<p>Then commit your changes to the repo and push! Make sure to include the <code>/docs</code> and <code>/memery</code> folders, and any notebooks you changed when you commit.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Contributing">Contributing<a class="anchor-link" href="#Contributing"> </a></h2><p>Memery is open source and you can contribute. See <a href="&#39;/CONTRIBUTING.md&#39;">CONTRIBUTING.md</a> for guidelines on how you can help.</p>
<h3 id="Who-works-on-this-project">Who works on this project<a class="anchor-link" href="#Who-works-on-this-project"> </a></h3><p>Memery was first written by Max Anton Brewer aka @deepfates in the summer of 2021. Some commits are listed from @robotface-io but that was just me using the wrong account when I first started.</p>
<p>I wrote this to solve my own needs and learn notebook-based development. I hope it helps other people too. If you can help me make it better, please do. I welcome any contribution, guidance or criticism.</p>
<p><strong>The ideal way to get support is to open an issue on Github</strong>. However, the <em>fastest</em> way to get a response from me is probably to <a href="twitter.com/deepfates">direct message me on twitter</a>. This is my first attempt to coordinate an open-source project, bear with me.</p>

</div>
</div>
</div>
</div>
 

