---

title: Encoder


keywords: fastai
sidebar: home_sidebar



nb_path: "03_encoder.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 03_encoder.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="image_encoder" class="doc_header"><code>image_encoder</code><a href="https://github.com/deepfates/memery/tree/main/memery/encoder.py#L15" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>image_encoder</code>(<strong><code>img_loader</code></strong>, <strong><code>device</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_files</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;images/memes/Wholesome-Meme-8.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;Wholesome-Meme-8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;images/memes/Wholesome-Meme-1.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;Wholesome-Meme-1&#39;</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">memery.crafter</span> <span class="kn">import</span> <span class="n">crafter</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">img_loader</span> <span class="o">=</span> <span class="n">crafter</span><span class="p">(</span><span class="n">new_files</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">img_loader</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>tensor([[[[ 1.9303e+00,  1.9303e+00,  1.9303e+00,  ...,  1.9303e+00,
            1.9303e+00,  1.9303e+00],
          [ 1.9303e+00,  1.9303e+00,  1.9303e+00,  ...,  1.9303e+00,
            1.9303e+00,  1.9303e+00],
          [ 1.9303e+00,  1.9303e+00,  1.9303e+00,  ...,  1.9303e+00,
            1.9303e+00,  1.9303e+00],
          ...,
          [ 1.9303e+00,  1.9303e+00,  1.9303e+00,  ...,  1.9303e+00,
            1.9303e+00,  1.9303e+00],
          [ 1.9303e+00,  1.9303e+00,  1.9303e+00,  ...,  1.9303e+00,
            1.9303e+00,  1.9303e+00],
          [ 1.9303e+00,  1.9303e+00,  1.9303e+00,  ...,  1.9303e+00,
            1.9303e+00,  1.9303e+00]],

         [[ 2.0749e+00,  2.0749e+00,  2.0749e+00,  ...,  2.0749e+00,
            2.0749e+00,  2.0749e+00],
          [ 2.0749e+00,  2.0749e+00,  2.0749e+00,  ...,  2.0749e+00,
            2.0749e+00,  2.0749e+00],
          [ 2.0749e+00,  2.0749e+00,  2.0749e+00,  ...,  2.0749e+00,
            2.0749e+00,  2.0749e+00],
          ...,
          [ 2.0749e+00,  2.0749e+00,  2.0749e+00,  ...,  2.0749e+00,
            2.0749e+00,  2.0749e+00],
          [ 2.0749e+00,  2.0749e+00,  2.0749e+00,  ...,  2.0749e+00,
            2.0749e+00,  2.0749e+00],
          [ 2.0749e+00,  2.0749e+00,  2.0749e+00,  ...,  2.0749e+00,
            2.0749e+00,  2.0749e+00]],

         [[ 2.1459e+00,  2.1459e+00,  2.1459e+00,  ...,  2.1459e+00,
            2.1459e+00,  2.1459e+00],
          [ 2.1459e+00,  2.1459e+00,  2.1459e+00,  ...,  2.1459e+00,
            2.1459e+00,  2.1459e+00],
          [ 2.1459e+00,  2.1459e+00,  2.1459e+00,  ...,  2.1459e+00,
            2.1459e+00,  2.1459e+00],
          ...,
          [ 2.1459e+00,  2.1459e+00,  2.1459e+00,  ...,  2.1459e+00,
            2.1459e+00,  2.1459e+00],
          [ 2.1459e+00,  2.1459e+00,  2.1459e+00,  ...,  2.1459e+00,
            2.1459e+00,  2.1459e+00],
          [ 2.1459e+00,  2.1459e+00,  2.1459e+00,  ...,  2.1459e+00,
            2.1459e+00,  2.1459e+00]]],


        [[[ 1.9303e+00,  1.9303e+00,  1.9303e+00,  ...,  1.9303e+00,
            1.9303e+00,  1.9303e+00],
          [ 1.9303e+00,  1.9303e+00,  1.9303e+00,  ...,  1.9303e+00,
            1.9303e+00,  1.9303e+00],
          [ 1.9303e+00,  1.9303e+00,  1.9303e+00,  ...,  1.9303e+00,
            1.9303e+00,  1.9303e+00],
          ...,
          [-1.7184e-01, -3.3242e-01, -4.2001e-01,  ..., -2.0103e-01,
           -1.4264e-01,  3.3439e-03],
          [-4.3461e-01, -5.3680e-01, -5.3680e-01,  ..., -2.4483e-01,
           -1.7184e-01, -6.9648e-02],
          [-6.3899e-01, -5.6599e-01, -5.3680e-01,  ..., -1.8644e-01,
           -2.0103e-01, -1.4264e-01]],

         [[ 2.0749e+00,  2.0749e+00,  2.0749e+00,  ...,  2.0749e+00,
            2.0749e+00,  2.0749e+00],
          [ 2.0749e+00,  2.0749e+00,  2.0749e+00,  ...,  2.0749e+00,
            2.0749e+00,  2.0749e+00],
          [ 2.0749e+00,  2.0749e+00,  2.0749e+00,  ...,  2.0749e+00,
            2.0749e+00,  2.0749e+00],
          ...,
          [-1.0124e-01, -2.6633e-01, -3.5637e-01,  ..., -5.2146e-01,
           -4.9144e-01, -5.0645e-01],
          [-3.7138e-01, -4.7644e-01, -4.7644e-01,  ..., -5.2146e-01,
           -4.9144e-01, -5.3647e-01],
          [-5.8149e-01, -5.0645e-01, -4.7644e-01,  ..., -4.6143e-01,
           -5.3647e-01, -5.5148e-01]],

         [[ 2.1459e+00,  2.1459e+00,  2.1459e+00,  ...,  2.1459e+00,
            2.1459e+00,  2.1459e+00],
          [ 2.1459e+00,  2.1459e+00,  2.1459e+00,  ...,  2.1459e+00,
            2.1459e+00,  2.1459e+00],
          [ 2.1459e+00,  2.1459e+00,  2.1459e+00,  ...,  2.1459e+00,
            2.1459e+00,  2.1459e+00],
          ...,
          [ 1.5509e-01, -1.3329e-03, -8.6653e-02,  ..., -4.7060e-01,
           -4.2793e-01, -3.8527e-01],
          [-1.0087e-01, -2.0041e-01, -2.0041e-01,  ..., -4.4215e-01,
           -3.9949e-01, -3.9949e-01],
          [-2.9995e-01, -2.2885e-01, -2.0041e-01,  ..., -3.4261e-01,
           -3.8527e-01, -3.8527e-01]]]])
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">image_embeddings</span> <span class="o">=</span> <span class="n">image_encoder</span><span class="p">(</span><span class="n">img_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>  0%|          | 0/1 [00:00&lt;?, ?it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-21-480b40cf8111&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>image_embeddings <span class="ansi-blue-fg">=</span> image_encoder<span class="ansi-blue-fg">(</span>img_loader<span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;ipython-input-17-bbfbadbfbfa3&gt;</span> in <span class="ansi-cyan-fg">image_encoder</span><span class="ansi-blue-fg">(img_loader, device)</span>
<span class="ansi-green-intense-fg ansi-bold">      4</span>     <span class="ansi-green-fg">with</span> torch<span class="ansi-blue-fg">.</span>no_grad<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span>         <span class="ansi-green-fg">for</span> images<span class="ansi-blue-fg">,</span> labels <span class="ansi-green-fg">in</span> tqdm<span class="ansi-blue-fg">(</span>img_loader<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">----&gt; 6</span><span class="ansi-red-fg">             </span>batch_features <span class="ansi-blue-fg">=</span> model<span class="ansi-blue-fg">.</span>encode_image<span class="ansi-blue-fg">(</span>images<span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>device<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      7</span>             image_embeddings <span class="ansi-blue-fg">=</span> torch<span class="ansi-blue-fg">.</span>cat<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">(</span>image_embeddings<span class="ansi-blue-fg">,</span> batch_features<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>device<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      8</span> 

<span class="ansi-red-fg">NameError</span>: name &#39;model&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">image_embeddings</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([2, 512])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The text encoder returns a 512d vector just like the image encoder</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="text_encoder" class="doc_header"><code>text_encoder</code><a href="https://github.com/deepfates/memery/tree/main/memery/encoder.py#L26" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>text_encoder</code>(<strong><code>text</code></strong>, <strong><code>device</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">text_embedding</span> <span class="o">=</span> <span class="n">text_encoder</span><span class="p">(</span><span class="s1">&#39;a funny dog meme&#39;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">text_embedding</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="image_query_encoder" class="doc_header"><code>image_query_encoder</code><a href="https://github.com/deepfates/memery/tree/main/memery/encoder.py#L34" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>image_query_encoder</code>(<strong><code>image</code></strong>, <strong><code>device</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

